#!/usr/bin/env python3
"""
analyze_results.py - Analyze ivshmem performance test results

This script loads the CSV files generated by host_writer and produces:
- Latency analysis: histogram plots, time series, percentile charts
- Bandwidth analysis: performance by frame type, success rates, duration analysis
- Detailed statistics (p50, p90, p95, p99, min, max, mean, stddev)
- Comprehensive performance report with visualizations
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import sys
import os
from pathlib import Path


def load_latency_data(csv_path='latency_results.csv'):
    """Load latency data from CSV file"""
    if not os.path.exists(csv_path):
        print(f"Error: {csv_path} not found")
        print("Run the host_writer test first to generate data.")
        return None
    
    df = pd.read_csv(csv_path)
    print(f"Loaded {len(df)} latency measurements from {csv_path}")
    return df


def load_bandwidth_data(csv_path='bandwidth_results.csv'):
    """Load bandwidth data from CSV file"""
    if not os.path.exists(csv_path):
        print(f"Warning: {csv_path} not found")
        return None
    
    df = pd.read_csv(csv_path)
    print(f"Loaded bandwidth test results from {csv_path}")
    return df


def calculate_statistics(data, column_name, unit='ns'):
    """Calculate comprehensive statistics for a data series"""
    stats = {
        'count': len(data),
        'min': data.min(),
        'max': data.max(),
        'mean': data.mean(),
        'median': data.median(),
        'std': data.std(),
        'p50': data.quantile(0.50),
        'p90': data.quantile(0.90),
        'p95': data.quantile(0.95),
        'p99': data.quantile(0.99),
        'p999': data.quantile(0.999) if len(data) >= 1000 else None,
    }
    
    print(f"\n{'='*60}")
    print(f"Statistics for {column_name}")
    print(f"{'='*60}")
    print(f"Count:         {stats['count']:>12}")
    print(f"Min:           {stats['min']:>12.2f} {unit}")
    print(f"Max:           {stats['max']:>12.2f} {unit}")
    print(f"Mean:          {stats['mean']:>12.2f} {unit}")
    print(f"Median (p50):  {stats['median']:>12.2f} {unit}")
    print(f"Std Dev:       {stats['std']:>12.2f} {unit}")
    print(f"\nPercentiles:")
    print(f"p50:           {stats['p50']:>12.2f} {unit}")
    print(f"p90:           {stats['p90']:>12.2f} {unit}")
    print(f"p95:           {stats['p95']:>12.2f} {unit}")
    print(f"p99:           {stats['p99']:>12.2f} {unit}")
    if stats['p999'] is not None:
        print(f"p99.9:         {stats['p999']:>12.2f} {unit}")
    
    return stats


def plot_latency_histogram(df, output_file='latency_histogram.png'):
    """Create histogram of latency distribution"""
    fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(12, 10))
    
    # Convert to microseconds for better readability
    latency_us = df['latency_us']
    
    # Main histogram
    ax1.hist(latency_us, bins=50, edgecolor='black', alpha=0.7, color='skyblue')
    ax1.set_xlabel('Latency (μs)', fontsize=12)
    ax1.set_ylabel('Frequency', fontsize=12)
    ax1.set_title('ivshmem Latency Distribution (Round-Trip)', fontsize=14, fontweight='bold')
    ax1.grid(True, alpha=0.3)
    
    # Add statistics text
    stats_text = f"Mean: {latency_us.mean():.2f} μs\n"
    stats_text += f"Median: {latency_us.median():.2f} μs\n"
    stats_text += f"Std Dev: {latency_us.std():.2f} μs\n"
    stats_text += f"p99: {latency_us.quantile(0.99):.2f} μs"
    ax1.text(0.98, 0.97, stats_text, transform=ax1.transAxes,
             verticalalignment='top', horizontalalignment='right',
             bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.8),
             fontsize=10, family='monospace')
    
    # Log scale histogram for better visibility of outliers
    ax2.hist(latency_us, bins=50, edgecolor='black', alpha=0.7, color='lightcoral')
    ax2.set_xlabel('Latency (μs)', fontsize=12)
    ax2.set_ylabel('Frequency (log scale)', fontsize=12)
    ax2.set_title('Latency Distribution (Log Scale)', fontsize=14, fontweight='bold')
    ax2.set_yscale('log')
    ax2.grid(True, alpha=0.3)
    
    plt.tight_layout()
    plt.savefig(output_file, dpi=150, bbox_inches='tight')
    print(f"\n✓ Histogram saved to {output_file}")
    
    return fig


def plot_latency_over_time(df, output_file='latency_over_time.png'):
    """Plot latency over time to show temporal patterns"""
    fig, ax = plt.subplots(figsize=(14, 6))
    
    ax.plot(df['iteration'], df['latency_us'], linewidth=0.5, alpha=0.6, color='steelblue')
    ax.set_xlabel('Iteration', fontsize=12)
    ax.set_ylabel('Latency (μs)', fontsize=12)
    ax.set_title('ivshmem Latency Over Time', fontsize=14, fontweight='bold')
    ax.grid(True, alpha=0.3)
    
    # Add median line
    median = df['latency_us'].median()
    ax.axhline(y=median, color='red', linestyle='--', linewidth=2, 
               label=f'Median: {median:.2f} μs', alpha=0.7)
    
    # Add p99 line
    p99 = df['latency_us'].quantile(0.99)
    ax.axhline(y=p99, color='orange', linestyle='--', linewidth=2, 
               label=f'p99: {p99:.2f} μs', alpha=0.7)
    
    ax.legend(loc='upper right')
    
    plt.tight_layout()
    plt.savefig(output_file, dpi=150, bbox_inches='tight')
    print(f"✓ Time series plot saved to {output_file}")
    
    return fig


def plot_percentile_chart(df, output_file='latency_percentiles.png'):
    """Create a percentile chart"""
    fig, ax = plt.subplots(figsize=(12, 8))
    
    percentiles = np.arange(0, 101, 1)
    latency_percentiles = [df['latency_us'].quantile(p/100) for p in percentiles]
    
    ax.plot(percentiles, latency_percentiles, linewidth=2, color='darkblue')
    ax.set_xlabel('Percentile', fontsize=12)
    ax.set_ylabel('Latency (μs)', fontsize=12)
    ax.set_title('ivshmem Latency Percentile Chart', fontsize=14, fontweight='bold')
    ax.grid(True, alpha=0.3)
    
    # Mark important percentiles
    important_p = [50, 90, 95, 99]
    for p in important_p:
        value = df['latency_us'].quantile(p/100)
        ax.plot(p, value, 'ro', markersize=8)
        ax.annotate(f'p{p}: {value:.2f} μs', 
                   xy=(p, value), xytext=(10, 10),
                   textcoords='offset points',
                   bbox=dict(boxstyle='round,pad=0.5', facecolor='yellow', alpha=0.7),
                   fontsize=9)
    
    plt.tight_layout()
    plt.savefig(output_file, dpi=150, bbox_inches='tight')
    print(f"✓ Percentile chart saved to {output_file}")
    
    return fig


def analyze_bandwidth_by_frame_type(bandwidth_df):
    """Analyze bandwidth results grouped by frame type"""
    if bandwidth_df is None or len(bandwidth_df) == 0:
        return None
    
    # Filter only successful transfers
    successful_df = bandwidth_df[bandwidth_df['data_verified'] == 1]
    
    analysis = {}
    for frame_type in successful_df['frame_type'].unique():
        frame_data = successful_df[successful_df['frame_type'] == frame_type]
        if len(frame_data) > 0:
            analysis[frame_type] = {
                'count': len(frame_data),
                'total_tests': len(bandwidth_df[bandwidth_df['frame_type'] == frame_type]),
                'success_rate': len(frame_data) / len(bandwidth_df[bandwidth_df['frame_type'] == frame_type]) * 100,
                'size_mb': frame_data['test_size_mb'].iloc[0],
                'size_bytes': frame_data['test_size_bytes'].iloc[0],
                'bandwidth_gbps': {
                    'min': frame_data['bandwidth_gbps'].min(),
                    'max': frame_data['bandwidth_gbps'].max(),
                    'mean': frame_data['bandwidth_gbps'].mean(),
                    'median': frame_data['bandwidth_gbps'].median(),
                    'std': frame_data['bandwidth_gbps'].std(),
                },
                'duration_ms': {
                    'min': frame_data['duration_ms'].min(),
                    'max': frame_data['duration_ms'].max(),
                    'mean': frame_data['duration_ms'].mean(),
                    'median': frame_data['duration_ms'].median(),
                    'std': frame_data['duration_ms'].std(),
                }
            }
    
    return analysis


def plot_bandwidth_analysis(bandwidth_df, output_file='bandwidth_analysis.png'):
    """Create comprehensive bandwidth analysis plots"""
    if bandwidth_df is None or len(bandwidth_df) == 0:
        print("No bandwidth data available for plotting")
        return None
    
    # Filter successful transfers
    successful_df = bandwidth_df[bandwidth_df['data_verified'] == 1]
    
    fig, ((ax1, ax2), (ax3, ax4)) = plt.subplots(2, 2, figsize=(16, 12))
    
    # 1. Bandwidth by frame type (box plot)
    frame_types = successful_df['frame_type'].unique()
    bandwidth_data = [successful_df[successful_df['frame_type'] == ft]['bandwidth_gbps'].values 
                     for ft in frame_types]
    
    ax1.boxplot(bandwidth_data, tick_labels=frame_types)
    ax1.set_ylabel('Bandwidth (GB/s)', fontsize=12)
    ax1.set_title('Bandwidth Distribution by Frame Type', fontsize=14, fontweight='bold')
    ax1.grid(True, alpha=0.3)
    
    # 2. Bandwidth vs Transfer Size
    # Create consistent color mapping
    colors = plt.cm.tab10(np.linspace(0, 1, len(frame_types)))
    color_map = {ft: colors[i] for i, ft in enumerate(frame_types)}
    
    # Plot each frame type with consistent colors
    for ft in frame_types:
        ft_data = successful_df[successful_df['frame_type'] == ft]
        ax2.scatter(ft_data['test_size_mb'], ft_data['bandwidth_gbps'], 
                   c=[color_map[ft]], label=ft, alpha=0.7, s=60)
    
    ax2.set_xlabel('Transfer Size (MB)', fontsize=12)
    ax2.set_ylabel('Bandwidth (GB/s)', fontsize=12)
    ax2.set_title('Bandwidth vs Transfer Size', fontsize=14, fontweight='bold')
    ax2.grid(True, alpha=0.3)
    ax2.legend()
    
    # 3. Transfer Duration by Frame Type
    duration_data = [successful_df[successful_df['frame_type'] == ft]['duration_ms'].values 
                    for ft in frame_types]
    
    ax3.boxplot(duration_data, tick_labels=frame_types)
    ax3.set_ylabel('Duration (ms)', fontsize=12)
    ax3.set_title('Transfer Duration by Frame Type', fontsize=14, fontweight='bold')
    ax3.grid(True, alpha=0.3)
    ax3.set_yscale('log')  # Log scale for better visibility
    
    # 4. Success Rate by Frame Type
    success_rates = []
    for ft in frame_types:
        total = len(bandwidth_df[bandwidth_df['frame_type'] == ft])
        successful = len(successful_df[successful_df['frame_type'] == ft])
        success_rates.append(successful / total * 100)
    
    bars = ax4.bar(frame_types, success_rates, color=['skyblue', 'lightgreen', 'lightcoral'])
    ax4.set_ylabel('Success Rate (%)', fontsize=12)
    ax4.set_title('Data Integrity Success Rate by Frame Type', fontsize=14, fontweight='bold')
    ax4.set_ylim(0, 105)
    ax4.grid(True, alpha=0.3, axis='y')
    
    # Add percentage labels on bars
    for bar, rate in zip(bars, success_rates):
        height = bar.get_height()
        ax4.text(bar.get_x() + bar.get_width()/2., height + 1,
                f'{rate:.1f}%', ha='center', va='bottom', fontweight='bold')
    
    plt.tight_layout()
    plt.savefig(output_file, dpi=150, bbox_inches='tight')
    print(f"✓ Bandwidth analysis plot saved to {output_file}")
    
    return fig


def generate_report(latency_df, bandwidth_df, output_file='performance_report.txt'):
    """Generate a text report with all statistics"""
    with open(output_file, 'w') as f:
        f.write("="*70 + "\n")
        f.write("IVSHMEM Performance Test Report\n")
        f.write("="*70 + "\n\n")
        
        # Latency statistics
        if latency_df is not None:
            f.write("LATENCY TEST (Round-Trip)\n")
            f.write("-"*70 + "\n")
            latency_us = latency_df['latency_us']
            latency_ns = latency_df['latency_ns']
            
            f.write(f"Total measurements:     {len(latency_df)}\n\n")
            
            f.write("Round-Trip Latency (nanoseconds):\n")
            f.write(f"  Min:                  {latency_ns.min():>12.0f} ns\n")
            f.write(f"  Max:                  {latency_ns.max():>12.0f} ns\n")
            f.write(f"  Mean:                 {latency_ns.mean():>12.0f} ns\n")
            f.write(f"  Median (p50):         {latency_ns.quantile(0.50):>12.0f} ns\n")
            f.write(f"  p90:                  {latency_ns.quantile(0.90):>12.0f} ns\n")
            f.write(f"  p95:                  {latency_ns.quantile(0.95):>12.0f} ns\n")
            f.write(f"  p99:                  {latency_ns.quantile(0.99):>12.0f} ns\n")
            if len(latency_df) >= 1000:
                f.write(f"  p99.9:                {latency_ns.quantile(0.999):>12.0f} ns\n")
            f.write(f"  Std Dev:              {latency_ns.std():>12.0f} ns\n\n")
            
            f.write("Round-Trip Latency (microseconds):\n")
            f.write(f"  Min:                  {latency_us.min():>12.2f} μs\n")
            f.write(f"  Max:                  {latency_us.max():>12.2f} μs\n")
            f.write(f"  Mean:                 {latency_us.mean():>12.2f} μs\n")
            f.write(f"  Median (p50):         {latency_us.quantile(0.50):>12.2f} μs\n")
            f.write(f"  p90:                  {latency_us.quantile(0.90):>12.2f} μs\n")
            f.write(f"  p95:                  {latency_us.quantile(0.95):>12.2f} μs\n")
            f.write(f"  p99:                  {latency_us.quantile(0.99):>12.2f} μs\n")
            if len(latency_df) >= 1000:
                f.write(f"  p99.9:                {latency_us.quantile(0.999):>12.2f} μs\n")
            f.write(f"  Std Dev:              {latency_us.std():>12.2f} μs\n\n")
            
            f.write("Estimated One-Way Latency (half of round-trip):\n")
            f.write(f"  Mean:                 {latency_ns.mean()/2:>12.0f} ns ({latency_us.mean()/2:>8.2f} μs)\n")
            f.write(f"  Median:               {latency_ns.median()/2:>12.0f} ns ({latency_us.median()/2:>8.2f} μs)\n\n")
        
        # Bandwidth statistics
        if bandwidth_df is not None and len(bandwidth_df) > 0:
            f.write("\n" + "="*70 + "\n")
            f.write("BANDWIDTH TEST\n")
            f.write("-"*70 + "\n")
            
            bandwidth_analysis = analyze_bandwidth_by_frame_type(bandwidth_df)
            
            if bandwidth_analysis:
                for frame_type, stats in bandwidth_analysis.items():
                    f.write(f"\n{frame_type.upper()} ({stats['size_mb']:.2f} MB):\n")
                    f.write(f"  Tests:                {stats['count']}/{stats['total_tests']} successful ({stats['success_rate']:.1f}%)\n")
                    f.write(f"  Bandwidth (GB/s):\n")
                    f.write(f"    Min:                {stats['bandwidth_gbps']['min']:>12.2f} GB/s\n")
                    f.write(f"    Max:                {stats['bandwidth_gbps']['max']:>12.2f} GB/s\n")
                    f.write(f"    Mean:               {stats['bandwidth_gbps']['mean']:>12.2f} GB/s\n")
                    f.write(f"    Median:             {stats['bandwidth_gbps']['median']:>12.2f} GB/s\n")
                    f.write(f"    Std Dev:            {stats['bandwidth_gbps']['std']:>12.2f} GB/s\n")
                    f.write(f"  Duration (ms):\n")
                    f.write(f"    Min:                {stats['duration_ms']['min']:>12.2f} ms\n")
                    f.write(f"    Max:                {stats['duration_ms']['max']:>12.2f} ms\n")
                    f.write(f"    Mean:               {stats['duration_ms']['mean']:>12.2f} ms\n")
                    f.write(f"    Median:             {stats['duration_ms']['median']:>12.2f} ms\n")
                    f.write(f"    Std Dev:            {stats['duration_ms']['std']:>12.2f} ms\n")
                
                # Overall bandwidth summary
                successful_df = bandwidth_df[bandwidth_df['data_verified'] == 1]
                f.write(f"\nOVERALL BANDWIDTH SUMMARY:\n")
                f.write(f"  Total tests:          {len(bandwidth_df)}\n")
                f.write(f"  Successful:           {len(successful_df)} ({len(successful_df)/len(bandwidth_df)*100:.1f}%)\n")
                f.write(f"  Peak bandwidth:       {successful_df['bandwidth_gbps'].max():.2f} GB/s\n")
                f.write(f"  Average bandwidth:    {successful_df['bandwidth_gbps'].mean():.2f} GB/s\n")
                f.write(f"  Fastest transfer:     {successful_df['duration_ms'].min():.2f} ms\n")
                f.write(f"  Slowest transfer:     {successful_df['duration_ms'].max():.2f} ms\n")
                
                f.write(f"\nNOTES:\n")
                f.write(f"  - High bandwidth values are due to CPU cache effects\n")
                f.write(f"  - First iteration often slower due to cache warming\n")
                f.write(f"  - Actual memory bandwidth typically ~25-50 GB/s for modern systems\n")
                f.write(f"  - SHA256 verification ensures data integrity across all transfers\n")
        
        f.write("\n" + "="*70 + "\n")
    
    print(f"✓ Performance report saved to {output_file}")


def main():
    print("="*70)
    print("IVSHMEM Performance Analysis")
    print("="*70)
    
    # Load data
    latency_df = load_latency_data()
    bandwidth_df = load_bandwidth_data()
    
    if latency_df is None:
        print("\nNo data to analyze. Exiting.")
        sys.exit(1)
    
    # Calculate and display statistics
    print("\n" + "="*70)
    print("LATENCY ANALYSIS")
    print("="*70)
    
    calculate_statistics(latency_df['latency_ns'], 'Round-Trip Latency (nanoseconds)', 'ns')
    calculate_statistics(latency_df['latency_us'], 'Round-Trip Latency (microseconds)', 'μs')
    
    print(f"\nEstimated One-Way Latency:")
    print(f"  Mean:    {latency_df['latency_ns'].mean()/2:>12.0f} ns ({latency_df['latency_us'].mean()/2:>8.2f} μs)")
    print(f"  Median:  {latency_df['latency_ns'].median()/2:>12.0f} ns ({latency_df['latency_us'].median()/2:>8.2f} μs)")
    
    # Bandwidth analysis
    if bandwidth_df is not None and len(bandwidth_df) > 0:
        print("\n" + "="*70)
        print("BANDWIDTH ANALYSIS")
        print("="*70)
        
        bandwidth_analysis = analyze_bandwidth_by_frame_type(bandwidth_df)
        if bandwidth_analysis:
            for frame_type, stats in bandwidth_analysis.items():
                print(f"\n{frame_type.upper()} ({stats['size_mb']:.2f} MB):")
                print(f"  Success Rate:         {stats['success_rate']:>8.1f}% ({stats['count']}/{stats['total_tests']})")
                print(f"  Bandwidth (GB/s):     {stats['bandwidth_gbps']['mean']:>8.2f} ± {stats['bandwidth_gbps']['std']:>6.2f}")
                print(f"    Range:              {stats['bandwidth_gbps']['min']:>8.2f} - {stats['bandwidth_gbps']['max']:>8.2f}")
                print(f"  Duration (ms):        {stats['duration_ms']['mean']:>8.2f} ± {stats['duration_ms']['std']:>6.2f}")
                print(f"    Range:              {stats['duration_ms']['min']:>8.2f} - {stats['duration_ms']['max']:>8.2f}")
            
            # Overall summary
            successful_df = bandwidth_df[bandwidth_df['data_verified'] == 1]
            print(f"\nOVERALL BANDWIDTH SUMMARY:")
            print(f"  Total tests:          {len(bandwidth_df)}")
            print(f"  Successful:           {len(successful_df)} ({len(successful_df)/len(bandwidth_df)*100:.1f}%)")
            print(f"  Peak bandwidth:       {successful_df['bandwidth_gbps'].max():.2f} GB/s")
            print(f"  Average bandwidth:    {successful_df['bandwidth_gbps'].mean():.2f} GB/s")
            print(f"  Fastest transfer:     {successful_df['duration_ms'].min():.2f} ms")
            print(f"  Slowest transfer:     {successful_df['duration_ms'].max():.2f} ms")
    
    # Generate plots
    print("\n" + "="*70)
    print("GENERATING PLOTS")
    print("="*70)
    
    plot_latency_histogram(latency_df)
    plot_latency_over_time(latency_df)
    plot_percentile_chart(latency_df)
    
    if bandwidth_df is not None and len(bandwidth_df) > 0:
        plot_bandwidth_analysis(bandwidth_df)
    
    # Generate report
    print("\n" + "="*70)
    print("GENERATING REPORT")
    print("="*70)
    generate_report(latency_df, bandwidth_df)
    
    print("\n" + "="*70)
    print("Analysis complete!")
    print("="*70)
    print("\nGenerated files:")
    print("  - latency_histogram.png")
    print("  - latency_over_time.png")
    print("  - latency_percentiles.png")
    if bandwidth_df is not None and len(bandwidth_df) > 0:
        print("  - bandwidth_analysis.png")
    print("  - performance_report.txt")


if __name__ == '__main__':
    main()

