#!/usr/bin/env python3
"""
analyze_results.py - Analyze ivshmem performance test results

This script loads the CSV files generated by host_writer and produces:
- Histogram plots of latency distribution
- Detailed statistics (p50, p90, p95, p99, min, max, mean, stddev)
- Summary report
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import sys
import os
from pathlib import Path


def load_latency_data(csv_path='latency_results.csv'):
    """Load latency data from CSV file"""
    if not os.path.exists(csv_path):
        print(f"Error: {csv_path} not found")
        print("Run the host_writer test first to generate data.")
        return None
    
    df = pd.read_csv(csv_path)
    print(f"Loaded {len(df)} latency measurements from {csv_path}")
    return df


def load_bandwidth_data(csv_path='bandwidth_results.csv'):
    """Load bandwidth data from CSV file"""
    if not os.path.exists(csv_path):
        print(f"Warning: {csv_path} not found")
        return None
    
    df = pd.read_csv(csv_path)
    print(f"Loaded bandwidth test results from {csv_path}")
    return df


def calculate_statistics(data, column_name, unit='ns'):
    """Calculate comprehensive statistics for a data series"""
    stats = {
        'count': len(data),
        'min': data.min(),
        'max': data.max(),
        'mean': data.mean(),
        'median': data.median(),
        'std': data.std(),
        'p50': data.quantile(0.50),
        'p90': data.quantile(0.90),
        'p95': data.quantile(0.95),
        'p99': data.quantile(0.99),
        'p999': data.quantile(0.999) if len(data) >= 1000 else None,
    }
    
    print(f"\n{'='*60}")
    print(f"Statistics for {column_name}")
    print(f"{'='*60}")
    print(f"Count:         {stats['count']:>12}")
    print(f"Min:           {stats['min']:>12.2f} {unit}")
    print(f"Max:           {stats['max']:>12.2f} {unit}")
    print(f"Mean:          {stats['mean']:>12.2f} {unit}")
    print(f"Median (p50):  {stats['median']:>12.2f} {unit}")
    print(f"Std Dev:       {stats['std']:>12.2f} {unit}")
    print(f"\nPercentiles:")
    print(f"p50:           {stats['p50']:>12.2f} {unit}")
    print(f"p90:           {stats['p90']:>12.2f} {unit}")
    print(f"p95:           {stats['p95']:>12.2f} {unit}")
    print(f"p99:           {stats['p99']:>12.2f} {unit}")
    if stats['p999'] is not None:
        print(f"p99.9:         {stats['p999']:>12.2f} {unit}")
    
    return stats


def plot_latency_histogram(df, output_file='latency_histogram.png'):
    """Create histogram of latency distribution"""
    fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(12, 10))
    
    # Convert to microseconds for better readability
    latency_us = df['latency_us']
    
    # Main histogram
    ax1.hist(latency_us, bins=50, edgecolor='black', alpha=0.7, color='skyblue')
    ax1.set_xlabel('Latency (μs)', fontsize=12)
    ax1.set_ylabel('Frequency', fontsize=12)
    ax1.set_title('ivshmem Latency Distribution (Round-Trip)', fontsize=14, fontweight='bold')
    ax1.grid(True, alpha=0.3)
    
    # Add statistics text
    stats_text = f"Mean: {latency_us.mean():.2f} μs\n"
    stats_text += f"Median: {latency_us.median():.2f} μs\n"
    stats_text += f"Std Dev: {latency_us.std():.2f} μs\n"
    stats_text += f"p99: {latency_us.quantile(0.99):.2f} μs"
    ax1.text(0.98, 0.97, stats_text, transform=ax1.transAxes,
             verticalalignment='top', horizontalalignment='right',
             bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.8),
             fontsize=10, family='monospace')
    
    # Log scale histogram for better visibility of outliers
    ax2.hist(latency_us, bins=50, edgecolor='black', alpha=0.7, color='lightcoral')
    ax2.set_xlabel('Latency (μs)', fontsize=12)
    ax2.set_ylabel('Frequency (log scale)', fontsize=12)
    ax2.set_title('Latency Distribution (Log Scale)', fontsize=14, fontweight='bold')
    ax2.set_yscale('log')
    ax2.grid(True, alpha=0.3)
    
    plt.tight_layout()
    plt.savefig(output_file, dpi=150, bbox_inches='tight')
    print(f"\n✓ Histogram saved to {output_file}")
    
    return fig


def plot_latency_over_time(df, output_file='latency_over_time.png'):
    """Plot latency over time to show temporal patterns"""
    fig, ax = plt.subplots(figsize=(14, 6))
    
    ax.plot(df['iteration'], df['latency_us'], linewidth=0.5, alpha=0.6, color='steelblue')
    ax.set_xlabel('Iteration', fontsize=12)
    ax.set_ylabel('Latency (μs)', fontsize=12)
    ax.set_title('ivshmem Latency Over Time', fontsize=14, fontweight='bold')
    ax.grid(True, alpha=0.3)
    
    # Add median line
    median = df['latency_us'].median()
    ax.axhline(y=median, color='red', linestyle='--', linewidth=2, 
               label=f'Median: {median:.2f} μs', alpha=0.7)
    
    # Add p99 line
    p99 = df['latency_us'].quantile(0.99)
    ax.axhline(y=p99, color='orange', linestyle='--', linewidth=2, 
               label=f'p99: {p99:.2f} μs', alpha=0.7)
    
    ax.legend(loc='upper right')
    
    plt.tight_layout()
    plt.savefig(output_file, dpi=150, bbox_inches='tight')
    print(f"✓ Time series plot saved to {output_file}")
    
    return fig


def plot_percentile_chart(df, output_file='latency_percentiles.png'):
    """Create a percentile chart"""
    fig, ax = plt.subplots(figsize=(12, 8))
    
    percentiles = np.arange(0, 101, 1)
    latency_percentiles = [df['latency_us'].quantile(p/100) for p in percentiles]
    
    ax.plot(percentiles, latency_percentiles, linewidth=2, color='darkblue')
    ax.set_xlabel('Percentile', fontsize=12)
    ax.set_ylabel('Latency (μs)', fontsize=12)
    ax.set_title('ivshmem Latency Percentile Chart', fontsize=14, fontweight='bold')
    ax.grid(True, alpha=0.3)
    
    # Mark important percentiles
    important_p = [50, 90, 95, 99]
    for p in important_p:
        value = df['latency_us'].quantile(p/100)
        ax.plot(p, value, 'ro', markersize=8)
        ax.annotate(f'p{p}: {value:.2f} μs', 
                   xy=(p, value), xytext=(10, 10),
                   textcoords='offset points',
                   bbox=dict(boxstyle='round,pad=0.5', facecolor='yellow', alpha=0.7),
                   fontsize=9)
    
    plt.tight_layout()
    plt.savefig(output_file, dpi=150, bbox_inches='tight')
    print(f"✓ Percentile chart saved to {output_file}")
    
    return fig


def generate_report(latency_df, bandwidth_df, output_file='performance_report.txt'):
    """Generate a text report with all statistics"""
    with open(output_file, 'w') as f:
        f.write("="*70 + "\n")
        f.write("IVSHMEM Performance Test Report\n")
        f.write("="*70 + "\n\n")
        
        # Latency statistics
        if latency_df is not None:
            f.write("LATENCY TEST (Round-Trip)\n")
            f.write("-"*70 + "\n")
            latency_us = latency_df['latency_us']
            latency_ns = latency_df['latency_ns']
            
            f.write(f"Total measurements:     {len(latency_df)}\n\n")
            
            f.write("Round-Trip Latency (nanoseconds):\n")
            f.write(f"  Min:                  {latency_ns.min():>12.0f} ns\n")
            f.write(f"  Max:                  {latency_ns.max():>12.0f} ns\n")
            f.write(f"  Mean:                 {latency_ns.mean():>12.0f} ns\n")
            f.write(f"  Median (p50):         {latency_ns.quantile(0.50):>12.0f} ns\n")
            f.write(f"  p90:                  {latency_ns.quantile(0.90):>12.0f} ns\n")
            f.write(f"  p95:                  {latency_ns.quantile(0.95):>12.0f} ns\n")
            f.write(f"  p99:                  {latency_ns.quantile(0.99):>12.0f} ns\n")
            if len(latency_df) >= 1000:
                f.write(f"  p99.9:                {latency_ns.quantile(0.999):>12.0f} ns\n")
            f.write(f"  Std Dev:              {latency_ns.std():>12.0f} ns\n\n")
            
            f.write("Round-Trip Latency (microseconds):\n")
            f.write(f"  Min:                  {latency_us.min():>12.2f} μs\n")
            f.write(f"  Max:                  {latency_us.max():>12.2f} μs\n")
            f.write(f"  Mean:                 {latency_us.mean():>12.2f} μs\n")
            f.write(f"  Median (p50):         {latency_us.quantile(0.50):>12.2f} μs\n")
            f.write(f"  p90:                  {latency_us.quantile(0.90):>12.2f} μs\n")
            f.write(f"  p95:                  {latency_us.quantile(0.95):>12.2f} μs\n")
            f.write(f"  p99:                  {latency_us.quantile(0.99):>12.2f} μs\n")
            if len(latency_df) >= 1000:
                f.write(f"  p99.9:                {latency_us.quantile(0.999):>12.2f} μs\n")
            f.write(f"  Std Dev:              {latency_us.std():>12.2f} μs\n\n")
            
            f.write("Estimated One-Way Latency (half of round-trip):\n")
            f.write(f"  Mean:                 {latency_ns.mean()/2:>12.0f} ns ({latency_us.mean()/2:>8.2f} μs)\n")
            f.write(f"  Median:               {latency_ns.median()/2:>12.0f} ns ({latency_us.median()/2:>8.2f} μs)\n\n")
        
        # Bandwidth statistics
        if bandwidth_df is not None and len(bandwidth_df) > 0:
            f.write("\n" + "="*70 + "\n")
            f.write("BANDWIDTH TEST\n")
            f.write("-"*70 + "\n")
            row = bandwidth_df.iloc[0]
            f.write(f"Transfer size:          {row['test_size_mb']:.2f} MB ({row['test_size_bytes']} bytes)\n")
            f.write(f"Transfer time:          {row['duration_ns']:,.0f} ns ({row['duration_ms']:.2f} ms)\n")
            f.write(f"Bandwidth:              {row['bandwidth_mbps']:.2f} MB/s ({row['bandwidth_gbps']:.2f} GB/s)\n")
            f.write(f"\nNote: High bandwidth is due to CPU cache effects.\n")
            f.write(f"      Actual memory bandwidth is typically ~25 GB/s for DDR4-3200.\n")
        
        f.write("\n" + "="*70 + "\n")
    
    print(f"✓ Performance report saved to {output_file}")


def main():
    print("="*70)
    print("IVSHMEM Performance Analysis")
    print("="*70)
    
    # Load data
    latency_df = load_latency_data()
    bandwidth_df = load_bandwidth_data()
    
    if latency_df is None:
        print("\nNo data to analyze. Exiting.")
        sys.exit(1)
    
    # Calculate and display statistics
    print("\n" + "="*70)
    print("LATENCY ANALYSIS")
    print("="*70)
    
    calculate_statistics(latency_df['latency_ns'], 'Round-Trip Latency (nanoseconds)', 'ns')
    calculate_statistics(latency_df['latency_us'], 'Round-Trip Latency (microseconds)', 'μs')
    
    print(f"\nEstimated One-Way Latency:")
    print(f"  Mean:    {latency_df['latency_ns'].mean()/2:>12.0f} ns ({latency_df['latency_us'].mean()/2:>8.2f} μs)")
    print(f"  Median:  {latency_df['latency_ns'].median()/2:>12.0f} ns ({latency_df['latency_us'].median()/2:>8.2f} μs)")
    
    # Generate plots
    print("\n" + "="*70)
    print("GENERATING PLOTS")
    print("="*70)
    
    plot_latency_histogram(latency_df)
    plot_latency_over_time(latency_df)
    plot_percentile_chart(latency_df)
    
    # Generate report
    print("\n" + "="*70)
    print("GENERATING REPORT")
    print("="*70)
    generate_report(latency_df, bandwidth_df)
    
    print("\n" + "="*70)
    print("Analysis complete!")
    print("="*70)
    print("\nGenerated files:")
    print("  - latency_histogram.png")
    print("  - latency_over_time.png")
    print("  - latency_percentiles.png")
    print("  - performance_report.txt")


if __name__ == '__main__':
    main()

